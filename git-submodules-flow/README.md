# Джедайский манускрипт по submodul'ям (субмодулям сабмодулям)

## Библия джедая

- Подумай 200 раз, а нужны ли тебе сабмодули, не проще ли просто разнести проект на 2 разных репо
- Если ты понял что нужны, подумай ещё 200 раз. Скорее всего, почти всегда можно обойтись без них
- работа с сабмодулями происходит только для инициализированных репо
- перед работой с сабмодулем инициализируй его через `git submodule update --init`
- после работы с сабмодулем деинициализируй его через `git submodule deinit`
- !!!!! в `.gitmodules` ни у одного сабмодуля не должно быть фиксации ветки !!!!!
- текущий комит сабмодуля является комитом на который ссылается основной репо
- по дефолту сабмодуль указывает на коммит, а не на ветку
- Для каждой ветки мейн-репо существует ветка проекта в сабмодуле с соответствующим названием (master - master, dev - dev, SCRUM-1488 - SCRUM-1488)
- Если сабмодуль состоит в нескольких мейн-репо, в названиях веток этих мейн-репо не должно быть коллизий

## Воркфлоу

- ещё см. `Команды джедайского воркфлоу` и `Команды гитовые`
- для остальных ситуаций как обычно

### Если требуется создать фичу

- `npm run git-c` на dev
- `npm run git-b` на новую ветку
- разработка фичи
- `npm run git-m` в dev

### Если сабмодуль оказался где-то не там
- либо в ветке сабмодуля `git checkout *текущая ветка*`
- либо `npm run git-c *ветка*`

## Команды джедайского воркфлоу

#### (checkout) npm run git-c *branch-name*

- 1. переключается на нужную ветку сначала в сабмодулях, затем в мейн репо
- ничего не комитит и не должна!

#### (branch) npm run git-b *branch-name*

- 1. создаёт ветку в родительском репо
- 2. создаёт ветку в сабмодулях

#### (merge) npm run git-m *branch-name*

- Команда обходит всё дерево сабмодулей с корнем мейн репо. Далее просто дерево.
- Обходит в глубину, от самого левого верхнего левого листа к корню, для каждого узла выполняя:
- 1. Если уже находимся на нужной ветке, идём к следующему листу
- 2. проверка наличия конфликтов при мердже, если есть конфликты, обрываем весь обход дерева
- 3. мердж без коммита
- 4. устанавливаем указатель на коммит сабмодулей (на 1 уровень в дереве) в те ветки, где сейчас находятся сабмодули
- 5. коммитим мердж

#### (pull) npm run git-p *branch-name*

- 1. Если `branch-name` не указан и текущая ветка в текущем мейн репо отсутствует, завершаем команду
- 2. `npm run git-c` на нужную ветку
- 3. аналогично команде `npm run git-m` в каждом узле дерева пулим изменения

## Команды гитовые

- см. https://git-scm.com/docs/git-submodule

#### git clone --recurse-submodules *url to repo*

- выкачать репо вместе со всеми его сабмодулями
- по дефолту выкачивается только код родительского репо

#### git submodule add *url to repo*

- добавить в проект новый сабмодуль
- выполнять нужно в папке в которую добавится сабмодуль
- добавляет запись о новом сабмодуле в `.gitmodules`, добавляет запись, и выкачивает файлы

#### git submodule update --init *path to submodule*

- для уже добавленного сабмодуля выкачать его код с его текущей ветки
- предназначена для сабмодуля, вызывается из папки родительского репо
- работает для всех сабмодулей, если не указывать путь
- не вносит никаких изменений ни в родительский репо ни в сабмодуль, просто выкачивает код с гитхаба

#### git submodule deinit *path to submodule*

- деинициализирует сабмодуль, очищает папку в которой он лежит
- предназначена для сабмодуля, вызывается из папки родительского репо
- в родительском репо ничего не меняется

#### git status --ignore-submodules=none

- показывает изменения во всех сабмодулях и в родительском репо
- вызывается в родительском репо

#### git push --recurse-submodules

- делает пуш для всего что движется
- вызывается в родительском репо

#### git submodule status

- показывает коммиты и ветки на которые ссылаются сабмодули в текущем коммите мейн-репо
- выполняется в основном репо

## Выпиливание сабмодуля в тартарары

- Заимствовано у джедаев англоговорящих планет (со стековерфлоу)
- Delete the relevant section from the .gitmodules file.
- Stage the .gitmodules changes git add .gitmodules
- Delete the relevant section from .git/config.
- Run git rm --cached path_to_submodule (no trailing slash).
- Run rm -rf .git/modules/path_to_submodule (no trailing slash).
- Commit git commit -m "Removed submodule "
- Delete the now untracked submodule files rm -rf path_to_submodule
